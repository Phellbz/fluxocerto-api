generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum MovementDirection {
  in
  out
}

enum MovementStatus {
  REALIZED
  PENDING
  CANCELED
}

enum CategoryFlowType {
  INCOME   @map("income")
  EXPENSE  @map("expense")
  TRANSFER @map("transfer")
}

enum CompanyRole {
  master
  admin
  financeiro
  estoque
  member
}

enum BankAccountType {
  checking @map("checking")
  savings  @map("savings")
  cash     @map("cash")
}

enum ContactType {
  client   @map("client")
  supplier @map("supplier")
  both     @map("both")
}

enum FinancialAccountKind {
  payable   @map("payable")
  receivable @map("receivable")
}

enum FinancialAccountStatus {
  open     @map("open")
  partial  @map("partial")
  paid     @map("paid")
  canceled @map("canceled")
}

enum InstallmentStatus {
  open    @map("open")
  partial @map("partial")
  paid    @map("paid")
}

enum BudgetStatus {
  draft     @map("draft")
  sent      @map("sent")
  approved  @map("approved")
  canceled  @map("canceled")
}

enum BudgetItemType {
  service  @map("service")
  material @map("material")
}

model BankAccount {
  id                 String          @id @default(uuid()) @map("id")
  companyId          String          @map("company_id")
  name               String          @map("name")
  institution        String          @map("institution") @default("")
  agency             String          @map("agency") @default("")
  accountNumber      String          @map("account_number") @default("")
  accountType        BankAccountType @map("account_type") @default(checking)
  openingBalance     Decimal?        @map("opening_balance") @db.Decimal(14, 2)
  openingBalanceDate DateTime?      @map("opening_balance_date") @db.Date
  isActive           Boolean         @map("is_active") @default(true)
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  company                Company                @relation(fields: [companyId], references: [id], onDelete: Restrict)
  movements              Movement[]
  financialAccounts      FinancialAccount[]
  financialAccountPayments FinancialAccountPayment[]
  budgets                Budget[]

  @@unique([companyId, name], map: "bank_accounts_company_name_unique")
  @@index([companyId])
  @@map("bank_accounts")
}

model Category {
  id          String           @id @default(uuid()) @map("id")
  companyId   String           @map("company_id")
  groupId     String?          @map("group_id")
  name        String           @map("name")
  groupName   String           @map("group_name") @default("")
  flowType    CategoryFlowType @default(EXPENSE) @map("flow_type")
  affectsCash Boolean          @default(true) @map("affects_cash")
  isSystem    Boolean          @default(false) @map("is_system")
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  company           Company           @relation(fields: [companyId], references: [id], onDelete: Restrict)
  movements         Movement[]
  financialAccounts FinancialAccount[]
  budgets           Budget[]

  @@unique([companyId, name], map: "categories_company_name_unique")
  @@index([companyId])
  @@map("categories")
}

model Contact {
  id        String      @id @default(uuid()) @map("id")
  companyId String      @map("company_id")
  type      ContactType @default(client) @map("type")
  document  String?     @map("document")
  name      String      @map("name") @default("")
  tradeName String      @map("trade_name") @default("")

  phone        String? @map("phone")
  email        String? @map("email")
  address      String? @map("address")
  neighborhood String? @map("neighborhood")
  city         String? @map("city")
  state        String? @map("state")
  zipCode      String? @map("zip_code")
  createdBy    String?  @map("created_by")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company           Company           @relation(fields: [companyId], references: [id], onDelete: Restrict)
  movements         Movement[]
  financialAccounts FinancialAccount[]
  budgetsAsClient   Budget[]

  @@unique([companyId, document], map: "contacts_company_document_unique")
  @@index([companyId])
  @@map("contacts")
}

model Department {
  id          String    @id @default(uuid()) @map("id")
  companyId   String    @map("company_id")
  name        String    @map("name")
  description String?   @map("description")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company           Company           @relation(fields: [companyId], references: [id], onDelete: Restrict)
  movements         Movement[]
  financialAccounts FinancialAccount[]
  budgets           Budget[]

  @@unique([companyId, name], map: "departments_company_name_unique")
  @@index([companyId])
  @@map("departments")
}

model FinancialAccount {
  id               String                 @id @default(uuid()) @map("id")
  companyId        String                 @map("company_id")
  kind             FinancialAccountKind   @map("kind")
  status           FinancialAccountStatus @map("status")
  contactId        String                 @map("contact_id")
  categoryId       String?                @map("category_id")
  departmentId     String?                @map("department_id")
  bankAccountId    String?                @map("bank_account_id")
  budgetId         String?                @map("budget_id")
  totalAmount      Decimal                @map("total_amount") @db.Decimal(14, 2)
  description     String                 @map("description")
  invoiceNumber    String?                @map("invoice_number")
  issueDate        DateTime               @map("issue_date") @db.Date
  isSettled        Boolean                @default(false) @map("is_settled")
  observations     String?                @map("observations")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")
  createdByUserId  String                 @map("created_by_user_id")
  updatedByUserId  String                 @map("updated_by_user_id")

  company    Company     @relation(fields: [companyId], references: [id], onDelete: Restrict)
  contact    Contact     @relation(fields: [contactId], references: [id], onDelete: Restrict)
  category   Category?   @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  budget     Budget?     @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  installments Installment[]
  payments   FinancialAccountPayment[]

  @@index([companyId])
  @@index([budgetId])
  @@map("financial_accounts")
}

model Installment {
  id                String            @id @default(uuid()) @map("id")
  companyId         String            @map("company_id")
  financialAccountId String           @map("financial_account_id")
  installmentNumber Int               @map("installment_number")
  dueDate           DateTime          @map("due_date") @db.Date
  amount            Decimal           @map("amount") @db.Decimal(14, 2)
  paidTotal         Decimal           @default(0) @map("paid_total") @db.Decimal(14, 2)
  status            InstallmentStatus @default(open) @map("status")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  createdByUserId   String           @map("created_by_user_id")
  updatedByUserId   String           @map("updated_by_user_id")

  company          Company               @relation(fields: [companyId], references: [id], onDelete: Restrict)
  financialAccount FinancialAccount      @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)
  payments         FinancialAccountPayment[]

  @@index([companyId])
  @@index([financialAccountId])
  @@map("installments")
}

model FinancialAccountPayment {
  id                 String           @id @default(uuid()) @map("id")
  companyId          String           @map("company_id")
  financialAccountId String           @map("financial_account_id")
  installmentId      String?          @map("installment_id")
  bankAccountId      String?          @map("bank_account_id")
  paymentDate        DateTime         @map("payment_date") @db.Date
  paidAmount         Decimal          @map("paid_amount") @db.Decimal(14, 2)
  interest           Decimal          @default(0) @map("interest") @db.Decimal(14, 2)
  discount           Decimal          @default(0) @map("discount") @db.Decimal(14, 2)
  notes              String?          @map("notes")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  createdByUserId    String           @map("created_by_user_id")
  updatedByUserId    String           @map("updated_by_user_id")

  company          Company          @relation(fields: [companyId], references: [id], onDelete: Restrict)
  financialAccount FinancialAccount @relation(fields: [financialAccountId], references: [id], onDelete: Restrict)
  installment      Installment?     @relation(fields: [installmentId], references: [id], onDelete: SetNull)
  bankAccount      BankAccount?     @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  movement         Movement?

  @@index([companyId])
  @@index([financialAccountId])
  @@index([installmentId])
  @@map("financial_account_payments")
}

model Movement {
  id           String            @id @default(uuid()) @map("id")
  companyId    String            @map("company_id")

  occurredAt   DateTime          @map("occurred_at")
  description  String            @map("description")
  amountCents  Int               @map("amount_cents")
  direction    MovementDirection @map("direction")

  // Relacionamentos opcionais (o form manda alguns deles)
  bankAccountId String?   @map("bank_account_id")
  categoryId    String?   @map("category_id")
  contactId     String?   @map("contact_id")
  departmentId  String?   @map("department_id")
  paymentId     String?   @unique @map("payment_id")

  bankAccount  BankAccount?             @relation(fields: [bankAccountId], references: [id])
  category     Category?                @relation(fields: [categoryId], references: [id])
  contact      Contact?                 @relation(fields: [contactId], references: [id])
  department   Department?              @relation(fields: [departmentId], references: [id])
  payment      FinancialAccountPayment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  // Campos opcionais do seu form (deixe simples por agora)
  project       String?         @map("project")
  documentType  String?         @map("document_type")
  documentNumber String?        @map("document_number")
  observations  String?         @map("observations")

  status       MovementStatus?  @map("status")
  source       String?          @map("source")
  isReconciled Boolean?         @map("is_reconciled")

  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  @@index([companyId, occurredAt])
  @@index([bankAccountId])
  @@index([categoryId])
  @@index([contactId])
  @@index([departmentId])
  @@map("movements")
}

model Budget {
  id                   String       @id @default(uuid()) @map("id")
  companyId            String       @map("company_id")
  budgetNumber         String       @map("budget_number")
  status               BudgetStatus @default(draft) @map("status")

  clientId             String?      @map("client_id")
  clientName           String?      @map("client_name")
  sellerName           String?      @map("seller_name")
  totalAmount          Decimal      @map("total_amount") @db.Decimal(14, 2)
  totalServices        Decimal      @default(0) @map("total_services") @db.Decimal(14, 2)
  totalMaterials       Decimal      @default(0) @map("total_materials") @db.Decimal(14, 2)
  discountValue        Decimal      @default(0) @map("discount_value") @db.Decimal(14, 2)
  expectedBillingDate  DateTime?    @map("expected_billing_date") @db.Date
  installmentCount    Int          @default(1) @map("installment_count")
  categoryId           String?      @map("category_id")
  departmentId         String?      @map("department_id")
  bankAccountId        String?      @map("bank_account_id")
  observations         String?      @map("observations")
  deletedAt            DateTime?    @map("deleted_at")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  createdByUserId      String       @map("created_by_user_id")
  updatedByUserId      String       @map("updated_by_user_id")

  company      Company       @relation(fields: [companyId], references: [id], onDelete: Restrict)
  client       Contact?     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  category     Category?    @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  bankAccount  BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  items        BudgetItem[]
  financialAccounts FinancialAccount[]

  @@unique([companyId, budgetNumber], map: "budgets_company_budget_number_unique")
  @@index([companyId], map: "budgets_company_idx")
  @@index([budgetNumber], map: "budgets_number_idx")
  @@map("budgets")
}

model BudgetItem {
  id                String         @id @default(uuid()) @map("id")
  companyId         String         @map("company_id")
  budgetId          String         @map("budget_id")
  itemType          BudgetItemType @map("item_type")
  productId         String?        @map("product_id")
  description       String         @map("description")
  quantity          Decimal        @map("quantity") @db.Decimal(14, 2)
  unitPrice         Decimal        @map("unit_price") @db.Decimal(14, 2)
  discountPercent   Decimal        @default(0) @map("discount_percent") @db.Decimal(14, 2)
  lineTotal         Decimal        @map("line_total") @db.Decimal(14, 2)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  createdByUserId   String        @map("created_by_user_id")
  updatedByUserId   String        @map("updated_by_user_id")

  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict)
  budget  Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([budgetId], map: "budget_items_budget_idx")
  @@map("budget_items")
}

model Product {
  id               String    @id @default(uuid()) @map("id")
  companyId        String    @map("company_id")
  codigoProduto    String    @map("codigo_produto") @default("")
  descricao        String    @map("descricao") @default("")
  unidade          String?   @map("unidade")
  precoCusto       Decimal?  @map("preco_custo") @db.Decimal(14, 2)
  precoVenda       Decimal?  @map("preco_venda") @db.Decimal(14, 2)
  estoqueAtual     Decimal?  @map("estoque_atual") @db.Decimal(14, 2)
  estoqueMinimo    Decimal?  @map("estoque_minimo") @db.Decimal(14, 2)
  estoqueInicial   Decimal?  @map("estoque_inicial") @db.Decimal(14, 2)
  localEstoque     String?   @map("local_estoque")
  ncm              String?   @map("ncm")
  codigoIntegracao String?   @map("codigo_integracao")
  marca            String?   @map("marca")
  familia          String?   @map("familia")
  modelo           String?   @map("modelo")
  tipo             String?   @map("tipo")
  pesoLiquido      Decimal?  @map("peso_liquido") @db.Decimal(14, 2)
  pesoBruto        Decimal?  @map("peso_bruto") @db.Decimal(14, 2)
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Restrict)
  budgetItems BudgetItem[]

  @@unique([companyId, codigoProduto], map: "products_company_codigo_unique")
  @@index([companyId], map: "products_company_idx")
  @@index([codigoProduto], map: "products_codigo_idx")
  @@map("products")
}

// --- Base estrutural multi-empresa (Etapa 01). Autenticação atual NÃO usa estas tabelas. ---

model AppUser {
  id           String   @id @default(uuid()) @map("id")
  email        String   @unique @map("email")
  name         String   @map("name")
  passwordHash String   @map("password_hash")
  avatarUrl    String?  @map("avatar_url")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  members CompanyMember[]

  @@map("app_users")
}

model Company {
  id        String    @id @default(uuid()) @map("id")
  name      String    @map("name")
  document  String?   @map("document")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members           CompanyMember[]
  config            CompanyConfig?
  bankAccounts      BankAccount[]
  contacts          Contact[]
  categories        Category[]
  departments       Department[]
  products          Product[]
  budgets           Budget[]
  budgetItems       BudgetItem[]
  financialAccounts FinancialAccount[]
  installments      Installment[]
  financialAccountPayments FinancialAccountPayment[]

  @@map("companies")
}

model CompanyMember {
  id        String      @id @default(uuid()) @map("id")
  companyId String      @map("company_id")
  userId    String      @map("user_id")
  role      CompanyRole @map("role")
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId], map: "company_members_company_user_unique")
  @@index([companyId], map: "company_members_company_idx")
  @@index([userId], map: "company_members_user_idx")
  @@map("company_members")
}

model CompanyConfig {
  companyId          String  @id @map("company_id")
  razaoSocial        String? @map("razao_social")
  nomeFantasia       String? @map("nome_fantasia")
  cnpj               String? @map("cnpj")
  inscricaoEstadual  String? @map("inscricao_estadual")
  inscricaoMunicipal String? @map("inscricao_municipal")
  regimeTributario   String? @map("regime_tributario")
  logradouro         String? @map("logradouro")
  numero             String? @map("numero")
  bairro             String? @map("bairro")
  cep                String? @map("cep")
  cidade             String? @map("cidade")
  estado             String? @map("estado")
  telefone           String? @map("telefone")
  email              String? @map("email")
  nomeContato        String? @map("nome_contato")
  logoUrl            String? @map("logo_url")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_config")
}
