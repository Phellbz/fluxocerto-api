generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum MovementDirection {
  in
  out
}

enum MovementStatus {
  REALIZED
  PENDING
  CANCELED
}

enum CategoryFlowType {
  INCOME   @map("income")
  EXPENSE  @map("expense")
  TRANSFER @map("transfer")
}

model BankAccount {
  id                 String    @id @default(uuid()) @map("id")
  companyId          String    @map("company_id")
  name               String    @map("name")
  institution        String    @map("institution") @default("")
  accountType        String    @map("account_type") @default("")
  openingBalance     Decimal?  @map("opening_balance") @db.Decimal(65, 30)
  openingBalanceDate DateTime? @map("opening_balance_date") @db.Date
  isActive           Boolean   @map("is_active") @default(true)
  agency             String    @map("agency") @default("")
  accountNumber      String    @map("account_number") @default("")
  createdAt          DateTime  @default(now()) @map("created_at")

  movements Movement[]

  @@index([companyId])
  @@map("bank_accounts")
}

model Category {
  id          String           @id @default(uuid()) @map("id")
  companyId   String           @map("company_id")
  groupId     String?          @map("group_id")
  name        String           @map("name")
  flowType    CategoryFlowType @default(EXPENSE) @map("flow_type")
  affectsCash Boolean          @default(true) @map("affects_cash")
  isActive    Boolean          @default(true) @map("is_active")
  groupName   String?          @map("group_name")
  createdAt   DateTime         @default(now()) @map("created_at")

  movements Movement[]

  @@unique([companyId, name], map: "categories_company_name_unique")
  @@index([companyId])
  @@map("categories")
}

model Contact {
  id           String    @id @default(uuid()) @map("id")
  companyId    String?   @map("company_id")

  type         String    @default("customer") @map("type")
  document     String    @default("") @map("document")
  name         String    @default("") @map("name")
  tradeName    String    @default("") @map("trade_name")

  phone        String?   @map("phone")
  email        String?   @map("email")
  city         String?   @map("city")
  state        String?   @map("state")
  address      String?   @map("address")
  neighborhood String?   @map("neighborhood")
  zipCode      String?   @map("zip_code")
  createdBy    String?   @map("created_by")

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  movements Movement[]

  @@index([companyId])
  @@map("contacts")
}

model Department {
  id          String    @id @default(uuid()) @map("id")
  companyId   String    @map("company_id")
  name        String    @map("name")
  description String?  @map("description")
  isActive    Boolean?  @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  movements Movement[]

  @@index([companyId])
  @@map("departments")
}

model Movement {
  id           String            @id @default(uuid()) @map("id")
  companyId    String            @map("company_id")

  occurredAt   DateTime          @map("occurred_at")
  description  String            @map("description")
  amountCents  Int               @map("amount_cents")
  direction    MovementDirection @map("direction")

  // Relacionamentos opcionais (o form manda alguns deles)
  bankAccountId String?   @map("bank_account_id")
  categoryId    String?   @map("category_id")
  contactId     String?   @map("contact_id")
  departmentId  String?   @map("department_id")

  bankAccount  BankAccount? @relation(fields: [bankAccountId], references: [id])
  category     Category?    @relation(fields: [categoryId], references: [id])
  contact      Contact?     @relation(fields: [contactId], references: [id])
  department   Department?  @relation(fields: [departmentId], references: [id])

  // Campos opcionais do seu form (deixe simples por agora)
  project       String?         @map("project")
  documentType  String?         @map("document_type")
  documentNumber String?        @map("document_number")
  observations  String?         @map("observations")

  status       MovementStatus?  @map("status")
  source       String?          @map("source")
  isReconciled Boolean?         @map("is_reconciled")

  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  @@index([companyId, occurredAt])
  @@index([bankAccountId])
  @@index([categoryId])
  @@index([contactId])
  @@index([departmentId])
  @@map("movements")
}

model Budget {
  id                   String    @id @default(uuid()) @map("id")
  companyId            String    @map("company_id")

  budgetNumber         String?   @map("budget_number")
  status               String?   @map("status")
  stage                String?   @map("stage")

  clientId             String?   @map("client_id")
  clientName           String?   @map("client_name")
  clientFullName       String?   @map("client_full_name")
  clientDocument       String?   @map("client_document")
  clientTags           String?   @map("client_tags")
  contactName          String?   @map("contact_name")

  totalServices        Decimal?  @map("total_services") @db.Decimal(14, 2)
  totalMaterials       Decimal?  @map("total_materials") @db.Decimal(14, 2)
  totalAmount          Decimal?  @map("total_amount") @db.Decimal(14, 2)

  installmentCount     Int?      @map("installment_count")
  paymentMethodLabel   String?   @map("payment_method_label")

  bankAccountId        String?   @map("bank_account_id")
  bankAccountName      String?   @map("bank_account_name")

  categoryId           String?   @map("category_id")
  categoryName         String?   @map("category_name")

  departmentId         String?   @map("department_id")

  advancePaymentStatus String?   @map("advance_payment_status")

  expectedBillingDate  DateTime? @map("expected_billing_date") @db.Date
  billedAt             DateTime? @map("billed_at")
  billedBy             String?   @map("billed_by")

  rpsDate              DateTime? @map("rps_date") @db.Date

  clientOrderNumber    String?   @map("client_order_number")
  sellerName           String?   @map("seller_name")
  projectName          String?   @map("project_name")
  contractNumber       String?   @map("contract_number")
  constructionCode     String?   @map("construction_code")
  artCode              String?   @map("art_code")
  productRemittance    String?   @map("product_remittance")
  observations         String?   @map("observations")

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  canceledAt           DateTime? @map("canceled_at")
  createdBy            String?   @map("created_by")

  items                BudgetItem[]

  @@index([companyId], map: "budgets_company_idx")
  @@index([budgetNumber], map: "budgets_number_idx")
  @@map("budgets")
}

model BudgetItem {
  id                  String   @id @default(uuid()) @map("id")
  budgetId            String?  @map("budget_id")
  itemType            String?  @map("item_type")
  productId           String?  @map("product_id")
  description         String?  @map("description")
  detailedDescription String?  @map("detailed_description")

  quantity        Decimal? @map("quantity") @db.Decimal(14, 2)
  unitPrice       Decimal? @map("unit_price") @db.Decimal(14, 2)
  discountPercent Decimal? @map("discount_percent") @db.Decimal(14, 2)
  lineTotal       Decimal? @map("line_total") @db.Decimal(14, 2)

  createdAt DateTime @default(now()) @map("created_at")

  budget Budget? @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId], map: "budget_items_budget_idx")
  @@map("budget_items")
}

model Product {
  id              String    @id @default(uuid()) @map("id")
  companyId       String    @map("company_id")

  codigoIntegracao String?  @map("codigo_integracao")
  codigoProduto    String?  @map("codigo_produto")
  descricao        String?  @map("descricao")
  ncm              String?  @map("ncm")
  unidade          String?  @map("unidade")
  familia          String?  @map("familia")
  marca            String?  @map("marca")
  modelo           String?  @map("modelo")
  tipo             String?  @map("tipo")
  localEstoque     String?  @map("local_estoque")

  estoqueMinimo   Decimal?  @map("estoque_minimo") @db.Decimal(14, 2)
  estoqueAtual    Decimal?  @map("estoque_atual") @db.Decimal(14, 2)
  estoqueInicial  Decimal?  @map("estoque_inicial") @db.Decimal(14, 2)

  precoCusto      Decimal?  @map("preco_custo") @db.Decimal(14, 2)
  precoVenda      Decimal?  @map("preco_venda") @db.Decimal(14, 2)

  pesoLiquido     Decimal?  @map("peso_liquido") @db.Decimal(14, 2)
  pesoBruto       Decimal?  @map("peso_bruto") @db.Decimal(14, 2)

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([companyId], map: "products_company_idx")
  @@index([codigoProduto], map: "products_codigo_idx")
  @@map("products")
}
